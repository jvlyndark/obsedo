<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Obsedo</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='styles.css') }}"
    />
    <style>
      /* Quick spacing and basic styling */
      body {
        font-family: sans-serif;
        max-width: 600px;
        margin: 2rem auto;
        padding: 0 1rem;
      }

      li {
        margin-bottom: 1.2em;
        padding: 0.5em;
        border-bottom: 1px solid #ccc;
        list-style: none;
      }

      button {
        margin-right: 0.5em;
        cursor: pointer;
      }

      input,
      select {
        margin: 0.3em 0.5em 0.3em 0;
      }
    </style>
  </head>
  <body>
    <h1>Obsedo</h1>

    <!-- Future feature: AI-powered task planning -->
    <form id="goal-form" style="opacity: 0.4" disabled>
      <input
        type="text"
        id="goal"
        placeholder="Confess your goal..."
        disabled
      />
      <button type="submit" disabled>Submit to Obsedo</button>
    </form>
    <small style="color: gray"
      >AI task planner coming soon. For now, add tasks manually below.</small
    >

    <h2>Add a Task Manually</h2>
    <form id="manual-task-form">
      <input type="text" id="task-title" placeholder="Title" required />
      <input type="text" id="task-category" placeholder="Category" required />
      <select id="task-priority">
        <option value="low">Low</option>
        <option value="medium" selected>Medium</option>
        <option value="high">High</option>
      </select>
      <input type="date" id="task-due-date" />
      <button type="submit">Add Task</button>
    </form>

    <ul id="task-list"></ul>

    <script>
      const list = document.getElementById("task-list");

      // Task complete
      list.addEventListener("click", async (e) => {
        if (e.target.classList.contains("complete-btn")) {
          const taskId = e.target.getAttribute("data-id");

          const res = await fetch(`/tasks/${taskId}/complete`, {
            method: "PATCH",
          });

          if (res.ok) {
            e.target.parentElement.style.opacity = 0.4;
            e.target.remove();
          } else {
            alert("Failed to mark task complete.");
          }
        }
      });

      // Task delete
      list.addEventListener("click", async (e) => {
        if (e.target.classList.contains("delete-btn")) {
          const taskId = e.target.getAttribute("data-id");

          const confirmed = confirm(
            "Are you sure you want to delete this task?"
          );
          if (!confirmed) return;

          const res = await fetch(`/tasks/${taskId}`, {
            method: "DELETE",
          });

          if (res.ok) {
            e.target.parentElement.remove();
          } else {
            alert("Failed to delete task.");
          }
        }
      });

      // Manual task add
      document
        .getElementById("manual-task-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const title = document.getElementById("task-title").value;
          const category = document.getElementById("task-category").value;
          const priority = document.getElementById("task-priority").value;
          const due_date =
            document.getElementById("task-due-date").value || null;

          const res = await fetch("/tasks", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ title, category, priority, due_date }),
          });

          const task = await res.json();
          if (res.ok) {
            const li = document.createElement("li");
            li.innerHTML = `
              <strong>${task.title}</strong><br>
              <small>Category: ${task.category} | Priority: ${task.priority}</small><br>
              <button data-id="${task.id}" class="complete-btn">Mark Complete</button>
              <button data-id="${task.id}" class="delete-btn">Delete</button>
            `;
            list.appendChild(li);
            e.target.reset();
          } else {
            alert("Error: " + (task.error || "Unknown"));
          }
        });

      // Load tasks
      async function loadTasks() {
        const res = await fetch("/tasks");
        const tasks = await res.json();
        list.innerHTML = "";

        tasks.forEach((task) => {
          const li = document.createElement("li");
          li.innerHTML = `
            <strong>${task.title}</strong><br>
            <small>Category: ${task.category} | Priority: ${
            task.priority
          }</small><br>
            ${
              task.is_completed
                ? ""
                : `<button data-id="${task.id}" class="complete-btn">Mark Complete</button>`
            }
            <button data-id="${task.id}" class="delete-btn">Delete</button>
          `;

          if (task.is_completed) {
            li.style.opacity = 0.4;
            const completeBtn = li.querySelector(".complete-btn");
            if (completeBtn) completeBtn.remove();
          }

          list.appendChild(li);
        });
      }

      loadTasks();
    </script>
  </body>
</html>
